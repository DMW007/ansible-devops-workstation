- hosts: all
  vars:
    - terraform_version: 0.12.17
    - terraform_plugin_dir: ~/.terraform.d/plugins
    # https://github.com/terra-farm/terraform-provider-virtualbox/releases
    - terraform_virtualbox_provider_version: 0.2.0
  pre_tasks:
    - name: Include vars file
      include_vars: vars.yml

    - set_fact:
        # No spaces to avoid breaking the url
        local_proxy_url: "{% if proxy_enabled %}http://{{ local_squid_host }}:{{ local_squid_port }}{% else %}{% endif %}"
  tasks:
    - name: Register proxy helpers
      import_role:
        name: proxy
      when: proxy_enabled

    - name: Install terraform
      import_role:
        name: terraform
      when: terraform_enabled

    - name: Install common software
      notify: Reconfigure virtualbox packages
      become: yes
      apt:
        name: ["virtualbox", "virtualbox-dkms", "linux-headers-generic"]
        state: present
        update_cache: yes
  handlers:
    - name: Reconfigure virtualbox packages
      # https://askubuntu.com/a/465455
      shell: |
        dpkg-reconfigure -fnoninteractive virtualbox-dkms virtualbox
        modprobe vboxdrv
      become: yes